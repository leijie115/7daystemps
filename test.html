<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Maker Score Dashboard (Standalone)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              slate: { 850: '#1e293b' }
            },
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif'],
            }
          }
        }
      }
    </script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
      body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
      [x-cloak] { display: none !important; }
      
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #f1f5f9; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0"
  }
}
</script>
</head>
<body class="bg-slate-100 text-slate-900 pb-12" x-data="dashboard()">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
        <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-lg">
                        <i data-lucide="activity" class="h-6 w-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-900 tracking-tight">Maker Score</h1>
                        <p class="text-xs text-slate-500 hidden sm:block">
                            Last updated: <span x-text="lastUpdated"></span>
                        </p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button @click="showBlockModal = true" class="bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 shadow-sm text-xs px-2.5 py-1.5 rounded-lg inline-flex items-center font-medium transition-all">
                        <i data-lucide="shield-alert" class="w-4 h-4 text-red-500 mr-2"></i>
                        Block List 
                        <span class="ml-1.5 bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-full text-xs font-bold" x-text="blockedList.length"></span>
                    </button>
                    
                    <button @click="showFakeModal = true" class="bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 shadow-sm text-xs px-2.5 py-1.5 rounded-lg inline-flex items-center font-medium transition-all">
                        <i data-lucide="database" class="w-4 h-4 text-orange-500 mr-2"></i>
                        Fake Data 
                        <span class="ml-1.5 bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-full text-xs font-bold" x-text="fakeList.length"></span>
                    </button>

                    <button @click="loadData()" :disabled="isLoading" class="bg-transparent hover:bg-slate-100 text-slate-600 p-2 rounded-lg transition-all" title="Refresh Data">
                        <i data-lucide="refresh-cw" class="w-4 h-4" :class="{ 'animate-spin': isLoading }"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Loading State -->
        <div x-show="isFirstLoad" class="min-h-[50vh] flex flex-col items-center justify-center space-y-4">
            <div class="relative">
                <div class="w-12 h-12 rounded-full border-4 border-slate-200"></div>
                <div class="absolute top-0 left-0 w-12 h-12 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
            </div>
            <p class="text-slate-500 font-medium animate-pulse">Loading Dashboard Data...</p>
        </div>

        <!-- Table Card -->
        <div x-show="!isFirstLoad" x-cloak class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead>
                        <tr class="bg-slate-800">
                            <!-- Exchange Filter Column (Fixed text color) -->
                            <th class="px-4 py-3 text-left w-48 sticky left-0 z-20 bg-slate-800 border-r border-slate-700">
                                <div class="relative inline-block text-left" x-data="{ open: false }" @click.outside="open = false">
                                    <button 
                                        @click="open = !open"
                                        class="flex items-center gap-1.5 px-2 py-1 rounded hover:bg-blue-700/50 transition-colors text-white text-xs font-semibold uppercase tracking-wider"
                                        :class="{ 'bg-blue-800': open }"
                                    >
                                        <span>Exchange</span>
                                        <i data-lucide="filter" class="w-3.5 h-3.5"></i>
                                    </button>

                                    <div 
                                        x-show="open"
                                        x-transition.opacity.duration.150ms
                                        class="absolute z-50 left-0 mt-2 w-56 origin-top-left bg-white rounded-lg shadow-xl ring-1 ring-black/5 focus:outline-none overflow-hidden flex flex-col max-h-96"
                                        style="display: none;"
                                    >
                                        <div class="p-2 border-b border-slate-100 bg-slate-50 sticky top-0">
                                            <div @click="toggleAllExchanges()" class="flex items-center px-2 py-1.5 rounded cursor-pointer hover:bg-slate-200 transition-colors">
                                                <div class="w-4 h-4 rounded border flex items-center justify-center mr-2" 
                                                     :class="allExchangesSelected ? 'bg-blue-600 border-blue-600' : 'border-slate-300 bg-white'">
                                                    <template x-if="allExchangesSelected">
                                                        <i data-lucide="check" class="w-3 h-3 text-white"></i>
                                                    </template>
                                                </div>
                                                <span class="text-sm font-medium text-slate-700">Select All</span>
                                            </div>
                                        </div>
                                        <div class="overflow-y-auto p-1">
                                            <template x-for="ex in availableExchanges" :key="ex">
                                                <div @click="toggleExchange(ex)" class="flex items-center px-2 py-1.5 rounded cursor-pointer hover:bg-slate-100 transition-colors">
                                                    <div class="w-4 h-4 rounded border flex items-center justify-center mr-2"
                                                         :class="selectedExchanges.includes(ex) ? 'bg-blue-600 border-blue-600' : 'border-slate-300 bg-white'">
                                                        <template x-if="selectedExchanges.includes(ex)">
                                                            <i data-lucide="check" class="w-3 h-3 text-white"></i>
                                                        </template>
                                                    </div>
                                                    <span class="text-sm text-slate-600 truncate" x-text="ex"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </th>
                            
                            <!-- Sortable Headers -->
                            <template x-for="col in columns" :key="col.key">
                                <th @click="sortBy(col.key)" 
                                    class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider cursor-pointer hover:bg-blue-700 transition-colors select-none group"
                                    :class="col.className || ''">
                                    <div class="flex items-center gap-1">
                                        <span x-text="col.label"></span>
                                        <!-- Active Sort Icon -->
                                        <template x-if="sortCol === col.key">
                                            <span class="text-white">
                                                <i :data-lucide="sortDesc ? 'arrow-down' : 'arrow-up'" class="w-4 h-4"></i>
                                            </span>
                                        </template>
                                        <!-- Hover Hint Icon (only if not sorted) -->
                                        <template x-if="sortCol !== col.key">
                                            <span class="opacity-0 group-hover:opacity-100 transition-opacity text-blue-300">
                                                <i data-lucide="arrow-down" class="w-4 h-4"></i>
                                            </span>
                                        </template>
                                    </div>
                                </th>
                            </template>

                            <th class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wider">Bot Account</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-white uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-slate-200">
                        <template x-if="sortedData.length === 0">
                            <tr>
                                <td colspan="12" class="px-6 py-12 text-center text-slate-500">
                                    No data matches your filter.
                                </td>
                            </tr>
                        </template>
                        
                        <template x-for="(item, idx) in sortedData" :key="item.exchange_name + item.coin_name">
                            <tr class="hover:bg-slate-50 transition-colors group">
                                <!-- Sticky First Col -->
                                <td class="px-4 py-3 whitespace-nowrap sticky left-0 bg-white group-hover:bg-slate-50 border-r border-slate-100 z-10">
                                    <div class="flex flex-col">
                                        <a href="#" @click.prevent="openExchangeUrl(item)" class="text-sm font-semibold text-blue-600 hover:text-blue-800 hover:underline mb-1" x-text="item.exchange_name"></a>
                                        <!-- Mobile View -->
                                        <div class="md:hidden flex flex-col gap-1 text-xs text-slate-500">
                                            <span class="flex items-center gap-1">
                                                <span class="font-medium text-slate-700" x-text="item.time_period + 'm'"></span>
                                                <span class="text-slate-300">|</span>
                                                <a :href="item.publicRecordUrl" target="_blank" class="hover:text-blue-600" x-text="item.coin_name"></a>
                                            </span>
                                            <span class="text-slate-400">Upd: <span x-text="item.updated"></span>m ago</span>
                                        </div>
                                    </div>
                                </td>

                                <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600 hidden md:table-cell">
                                    <span class="bg-slate-100 text-slate-700 px-2 py-1 rounded text-xs font-medium border border-slate-200" x-text="item.time_period + 'm'"></span>
                                </td>

                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-900 hidden md:table-cell">
                                    <a :href="item.publicRecordUrl" target="_blank" class="flex items-center gap-1 hover:text-blue-600">
                                        <span x-text="item.coin_name"></span>
                                        <i data-lucide="external-link" class="w-3 h-3 text-slate-400"></i>
                                    </a>
                                </td>

                                <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700 font-medium tabular-nums" x-text="item.s"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700 tabular-nums" x-text="item.r"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700 tabular-nums" x-text="item.v"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700 tabular-nums" x-text="item.round"></td>
                                
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600 tabular-nums hidden lg:table-cell" x-text="item.timeUniformity"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600 tabular-nums hidden lg:table-cell" x-text="item.tradeUniformity"></td>

                                <td class="px-4 py-3 whitespace-nowrap text-sm hidden sm:table-cell">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium" 
                                          :class="item.updated < 10 ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-800'"
                                          x-text="item.updated + 'm'">
                                    </span>
                                </td>

                                <td class="px-4 py-3 whitespace-nowrap">
                                    <template x-if="item.hasRunningBot && item.botsInfo.length > 0">
                                        <div class="flex flex-wrap gap-2">
                                            <template x-for="bot in item.botsInfo" :key="bot.bot">
                                                <a :href="bot.url" target="_blank" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-50 text-green-700 border border-green-200 hover:bg-green-100 transition-colors">
                                                    <i data-lucide="bot" class="w-3 h-3 mr-1"></i>
                                                    <span x-text="bot.account"></span>
                                                </a>
                                            </template>
                                        </div>
                                    </template>
                                    <template x-if="!item.hasRunningBot">
                                        <span class="text-slate-300 text-xs">-</span>
                                    </template>
                                </td>

                                <td class="px-4 py-3 whitespace-nowrap text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <button @click="handleAction('block', item)" 
                                                class="bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 p-1.5 rounded-lg transition-colors"
                                                :class="{ 'opacity-50 cursor-not-allowed': isActionLoading(item, 'block') }"
                                                title="Block Item">
                                            <i :data-lucide="isActionLoading(item, 'block') ? 'loader-2' : 'ban'" 
                                               class="w-4 h-4" 
                                               :class="{ 'animate-spin': isActionLoading(item, 'block') }"></i>
                                        </button>
                                        <button @click="handleAction('fake', item)" 
                                                class="bg-white border border-orange-200 text-orange-600 hover:bg-orange-50 p-1.5 rounded-lg transition-colors"
                                                :class="{ 'opacity-50 cursor-not-allowed': isActionLoading(item, 'fake') }"
                                                title="Add Fake Data">
                                            <i :data-lucide="isActionLoading(item, 'fake') ? 'loader-2' : 'file-plus'"
                                               class="w-4 h-4"
                                               :class="{ 'animate-spin': isActionLoading(item, 'fake') }"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Block Modal -->
    <div x-show="showBlockModal" x-cloak class="relative z-50">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" @click="showBlockModal = false"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4 sm:p-6 pointer-events-none">
            <div class="pointer-events-auto relative w-full max-w-2xl max-h-[85vh] flex flex-col bg-white rounded-xl shadow-2xl animate-in zoom-in-95 duration-200">
                <div class="flex items-center justify-between px-6 py-4 border-b border-slate-100">
                    <h3 class="text-lg font-semibold text-slate-800">Blocked Items</h3>
                    <button @click="showBlockModal = false" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-6">
                    <template x-if="blockedList.length === 0">
                        <div class="text-center py-8 text-slate-500">No blocked items.</div>
                    </template>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" x-show="blockedList.length > 0">
                        <template x-for="item in blockedList" :key="item.exchange_name + item.coin_name">
                            <div class="flex items-center justify-between p-3 bg-red-50 border border-red-100 rounded-lg group hover:border-red-200 transition-colors">
                                <div class="flex flex-col">
                                    <span class="font-medium text-slate-800 text-sm" x-text="item.exchange_name"></span>
                                    <span class="text-xs text-slate-500" x-text="item.coin_name"></span>
                                </div>
                                <button @click="handleAction('unblock', item)" class="p-1.5 bg-white text-red-500 rounded-md border border-red-100 shadow-sm hover:bg-red-500 hover:text-white transition-all">
                                    <i :data-lucide="isActionLoading(item, 'unblock') ? 'loader-2' : 'trash-2'"
                                       class="w-4 h-4"
                                       :class="{ 'animate-spin': isActionLoading(item, 'unblock') }"></i>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fake Modal -->
    <div x-show="showFakeModal" x-cloak class="relative z-50">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" @click="showFakeModal = false"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4 sm:p-6 pointer-events-none">
            <div class="pointer-events-auto relative w-full max-w-2xl max-h-[85vh] flex flex-col bg-white rounded-xl shadow-2xl animate-in zoom-in-95 duration-200">
                <div class="flex items-center justify-between px-6 py-4 border-b border-slate-100">
                    <h3 class="text-lg font-semibold text-slate-800">Fake Data Entries</h3>
                    <button @click="showFakeModal = false" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-6">
                    <template x-if="fakeList.length === 0">
                        <div class="text-center py-8 text-slate-500">No fake data entries.</div>
                    </template>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3" x-show="fakeList.length > 0">
                        <template x-for="item in fakeList" :key="item.exchange_name + item.coin_name">
                            <div class="p-3 bg-orange-50 border border-orange-100 rounded-lg">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="w-2 h-2 rounded-full bg-orange-400"></div>
                                    <span class="font-medium text-slate-800 text-sm" x-text="item.exchange_name"></span>
                                </div>
                                <span class="text-xs text-slate-500 font-mono bg-white px-1.5 py-0.5 rounded border border-orange-100" x-text="item.coin_name"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MOCK DATA GENERATOR
        const MOCK_DATA = [
          { exchange_name: 'Binance', coin_name: 'BTC_USDT', time_period: '15', s: 98.5, r: 12.4, v: 4500000, round: 124, timeUniformity: 0.95, tradeUniformity: 0.88, updated: 2, is_fake_data: 0, is_block: 0, hasRunningBot: true, botsInfo: [{ bot: 'b1', account: 'MainBot', url: '#' }], publicRecordUrl: 'https://www.binance.com/en/trade/BTC_USDT' },
          { exchange_name: 'OKX', coin_name: 'ETH_USDT', time_period: '5', s: 92.1, r: 8.5, v: 1200000, round: 89, timeUniformity: 0.91, tradeUniformity: 0.82, updated: 5, is_fake_data: 0, is_block: 0, hasRunningBot: false, botsInfo: [], publicRecordUrl: 'https://www.okx.com/trade-spot/eth-usdt' },
          { exchange_name: 'Bybit', coin_name: 'SOL_USDT', time_period: '60', s: 85.4, r: 15.2, v: 890000, round: 45, timeUniformity: 0.78, tradeUniformity: 0.65, updated: 12, is_fake_data: 0, is_block: 0, hasRunningBot: true, botsInfo: [{ bot: 'b2', account: 'SolBot', url: '#' }], publicRecordUrl: 'https://www.bybit.com/trade/usdt/SOLUSDT' },
          { exchange_name: 'KuCoin', coin_name: 'DOGE_USDT', time_period: '15', s: 45.2, r: 2.1, v: 150000, round: 12, timeUniformity: 0.45, tradeUniformity: 0.30, updated: 25, is_fake_data: 0, is_block: 0, hasRunningBot: false, botsInfo: [], publicRecordUrl: 'https://www.kucoin.com/trade/DOGE-USDT' },
          { exchange_name: 'Binance', coin_name: 'XRP_USDT', time_period: '5', s: 76.8, r: 5.4, v: 320000, round: 67, timeUniformity: 0.82, tradeUniformity: 0.75, updated: 1, is_fake_data: 0, is_block: 0, hasRunningBot: false, botsInfo: [], publicRecordUrl: 'https://www.binance.com/en/trade/XRP_USDT' },
          { exchange_name: 'Gate.io', coin_name: 'PEPE_USDT', time_period: '15', s: 88.9, r: 25.4, v: 560000, round: 112, timeUniformity: 0.89, tradeUniformity: 0.85, updated: 3, is_fake_data: 1, is_block: 0, hasRunningBot: false, botsInfo: [], publicRecordUrl: 'https://www.gate.io/trade/PEPE_USDT' },
          { exchange_name: 'Bitget', coin_name: 'ARB_USDT', time_period: '30', s: 65.4, r: 10.1, v: 420000, round: 56, timeUniformity: 0.70, tradeUniformity: 0.60, updated: 8, is_fake_data: 0, is_block: 0, hasRunningBot: true, botsInfo: [{ bot: 'b3', account: 'ArbBot', url: '#' }], publicRecordUrl: 'https://www.bitget.com/spot/ARBUSDT' },
          { exchange_name: 'HTX', coin_name: 'TRX_USDT', time_period: '5', s: 32.1, r: 1.5, v: 210000, round: 34, timeUniformity: 0.99, tradeUniformity: 0.20, updated: 4, is_fake_data: 0, is_block: 1, hasRunningBot: false, botsInfo: [], publicRecordUrl: 'https://www.htx.com/trade/trx_usdt' }
        ];

        document.addEventListener('alpine:init', () => {
            Alpine.data('dashboard', () => ({
                // Data State
                rawItems: [],
                blockedList: [],
                fakeList: [],
                
                // UI State
                availableExchanges: [],
                selectedExchanges: [],
                
                sortCol: 'r',
                sortDesc: true,
                
                isLoading: false,
                isFirstLoad: true,
                lastUpdated: new Date().toLocaleTimeString(),
                
                actionLoadingKeys: new Set(),
                
                showBlockModal: false,
                showFakeModal: false,

                // Column Config
                columns: [
                    { key: 'time_period', label: 'Period', className: 'hidden md:table-cell' },
                    { key: 'coin_name', label: 'Pair', className: 'hidden md:table-cell' },
                    { key: 's', label: 'Score' },
                    { key: 'r', label: 'Reward' },
                    { key: 'v', label: 'Volume' },
                    { key: 'round', label: 'Round' },
                    { key: 'timeUniformity', label: 'Time Unif.', className: 'hidden lg:table-cell' },
                    { key: 'tradeUniformity', label: 'Trade Unif.', className: 'hidden lg:table-cell' },
                    { key: 'updated', label: 'Updated', className: 'hidden sm:table-cell' }
                ],

                async init() {
                    // Initial load
                    await this.loadData();
                    this.isFirstLoad = false;

                    // Refresh icons after DOM updates
                    this.$watch('rawItems', () => this.$nextTick(() => lucide.createIcons()));
                    this.$watch('blockedList', () => this.$nextTick(() => lucide.createIcons()));
                    this.$watch('fakeList', () => this.$nextTick(() => lucide.createIcons()));
                    
                    // Polling
                    setInterval(() => this.loadData(true), 100000);
                },

                async loadData(silent = false) {
                    if (!silent && !this.isFirstLoad) this.isLoading = true;
                    
                    // Simulate API Delay
                    await new Promise(r => setTimeout(r, 600));

                    const normal = [];
                    const blocked = [];
                    const fake = [];
                    const exchanges = new Set();

                    // Clone Mock Data to simulate fetch
                    // In a real app, this is where fetch() would happen
                    const fetchedData = JSON.parse(JSON.stringify(MOCK_DATA));

                    fetchedData.forEach(item => {
                        if (item.is_fake_data === 1) fake.push(item);
                        else if (item.is_block === 1) blocked.push(item);
                        else {
                            normal.push(item);
                            exchanges.add(item.exchange_name);
                        }
                    });

                    this.rawItems = normal;
                    this.blockedList = blocked;
                    this.fakeList = fake;
                    this.lastUpdated = new Date().toLocaleTimeString();

                    // Update exchanges
                    const exchangeList = Array.from(exchanges).sort();
                    this.availableExchanges = exchangeList;
                    
                    // Initial Select All
                    if (this.isFirstLoad) {
                        this.selectedExchanges = [...exchangeList];
                    }

                    this.isLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                },

                get sortedData() {
                    return this.rawItems
                        .filter(i => this.selectedExchanges.includes(i.exchange_name))
                        .sort((a, b) => {
                            let valA = a[this.sortCol];
                            let valB = b[this.sortCol];

                            if (valA === null) valA = '';
                            if (valB === null) valB = '';

                            const aNum = parseFloat(valA);
                            const bNum = parseFloat(valB);

                            if (!isNaN(aNum) && !isNaN(bNum)) {
                                return this.sortDesc ? bNum - aNum : aNum - bNum;
                            }

                            const aStr = String(valA).toLowerCase();
                            const bStr = String(valB).toLowerCase();
                            
                            if (aStr < bStr) return this.sortDesc ? 1 : -1;
                            if (aStr > bStr) return this.sortDesc ? -1 : 1;
                            return 0;
                        });
                },

                get allExchangesSelected() {
                    return this.availableExchanges.length > 0 && 
                           this.selectedExchanges.length === this.availableExchanges.length;
                },

                sortBy(col) {
                    if (this.sortCol === col) {
                        this.sortDesc = !this.sortDesc;
                    } else {
                        this.sortCol = col;
                        this.sortDesc = true;
                    }
                    this.$nextTick(() => lucide.createIcons());
                },

                toggleExchange(ex) {
                    if (this.selectedExchanges.includes(ex)) {
                        this.selectedExchanges = this.selectedExchanges.filter(e => e !== ex);
                    } else {
                        this.selectedExchanges.push(ex);
                    }
                },

                toggleAllExchanges() {
                    if (this.allExchangesSelected) {
                        this.selectedExchanges = [];
                    } else {
                        this.selectedExchanges = [...this.availableExchanges];
                    }
                },

                async handleAction(type, item) {
                    const key = type + item.exchange_name + item.coin_name;
                    if (this.actionLoadingKeys.has(key)) return;
                    
                    this.actionLoadingKeys.add(key);
                    // Force refresh for reactivity on Set
                    this.actionLoadingKeys = new Set(this.actionLoadingKeys); 

                    // Mock API Call
                    await new Promise(r => setTimeout(r, 400));
                    
                    // Modify Local State (Simulating Backend Update)
                    const targetRef = MOCK_DATA.find(i => i.exchange_name === item.exchange_name && i.coin_name === item.coin_name);
                    
                    if (targetRef) {
                        if (type === 'block') targetRef.is_block = 1;
                        if (type === 'fake') targetRef.is_fake_data = 1;
                        if (type === 'unblock') targetRef.is_block = 0;
                    }

                    // Reload
                    await this.loadData(true);
                    
                    if (type === 'unblock' && this.blockedList.length === 0) {
                        this.showBlockModal = false;
                    }

                    this.actionLoadingKeys.delete(key);
                    this.actionLoadingKeys = new Set(this.actionLoadingKeys);
                },

                isActionLoading(item, type) {
                    return this.actionLoadingKeys.has(type + item.exchange_name + item.coin_name);
                },

                openExchangeUrl(item) {
                    // Complex logic ported from React component
                    const coinsWithoutBot = this.rawItems
                        .filter(i => i.exchange_name === item.exchange_name && !i.hasRunningBot)
                        .map(i => i.coin_name.split('_')[0]);
                    
                    const uniqueCoins = [...new Set(coinsWithoutBot)];
                    let baseUrl = item.publicRecordUrl;

                    if (uniqueCoins.length === 0) {
                        if (baseUrl.includes('from=')) {
                            baseUrl = baseUrl.replace(/from=[^&]+/, 'from=now-5m');
                        } else {
                            const separator = baseUrl.includes('?') ? '&' : '?';
                            baseUrl = baseUrl + separator + 'from=now-5m';
                        }
                        window.open(baseUrl, '_blank');
                        return;
                    }

                    baseUrl = baseUrl.replace(/&var-currency=[^&]*/g, '');
                    if (baseUrl.includes('from=')) {
                        baseUrl = baseUrl.replace(/from=[^&]+/, 'from=now-5m');
                    } else {
                        const separator = baseUrl.includes('?') ? '&' : '?';
                        baseUrl = baseUrl + separator + 'from=now-5m';
                    }

                    const currencyParams = uniqueCoins.map(coin => `&var-currency=${coin}`).join('');
                    const enhancedUrl = baseUrl + currencyParams;
                    window.open(enhancedUrl, '_blank');
                }
            }))
        })
    </script>
</body>
</html>